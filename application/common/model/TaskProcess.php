<?phpnamespace app\common\model;use think\Cache;use think\Db;use think\Exception;use app\common\model\Process;use think\Session;//任务工序流程class TaskProcess extends BaseModel{    //添加任务工序流程    function addProcess($data)    {        $this->allowField(true)->save($data);    }    //领取任务工序流程(领取任务)    function beginProcess($data)    {        $item['process_status'] = 1;        $item['confirm_time'] = time();        //按部门存入用户id        switch ($data['depart_id']){            case 2://钢筋班                $item['rebar_id'] = $data['user_id'];                break;            case 3://制梁班                $item['beam_id'] = $data['user_id'];                break;            case 4://安质部                $item['quality_id'] = $data['user_id'];                break;            case 5://试验室                $item['lab_id'] = $data['user_id'];                break;            case 6://物机部                $item['machine_id'] = $data['user_id'];                break;            case 7://预应力班                $item['prestress_id'] = $data['user_id'];                break;            case 8://拌合站                $item['blend_id'] = $data['user_id'];                break;        }        $where['task_id'] = $data['task_id'];        $where['process_id'] = $data['process_id'];        //返工状态        $return_status = $this->where($where)->value('return_status');        if ($return_status == 0){//正常领取            $item['first_time'] = time();        }        $this->where($where)->update($item);    }    //修改任务工序流程(任务完成)    function editProcess($data)    {        $where['task_id'] = $data['task_id'];        $where['process_id'] = $data['process_id'];        //是否需要技术员确认        /*$technologist_affirm = $this->where($where)->value('technologist_affirm');        if ($technologist_affirm != -1){            //技术员确认字段归0            $item['technologist_affirm'] = 0;        }*/        $item['technologist_affirm'] = 0;        $item['process_status'] = 2;        $item['used_time'] = $data['used_time'];        $item['finish_time'] = time();        $this->where($where)->update($item);    }    //修改任务工序流程(返工)    function returnProcess($data)    {        $item['return_status'] = 1;//返工状态        $item['process_status'] = 0;//进行状态=>0(未确认)        $item['technologist_affirm'] = 2;//技术员确认(未通过)        $where['task_id'] = $data['task_id'];        $where['process_id'] = $data['process_id'];        $this->where($where)->update($item);    }    //获取任务所有工序    function getProgress($task_id,$page=1)    {        $data = $this->alias('tp')            ->join('process p','p.id=tp.process_id')            ->field([                'tp.process_id',                'p.title',                'p.time_limit',                'tp.process_status',                'tp.first_time',                'tp.confirm_time',                'tp.finish_time',                'tp.used_time',                'tp.return_status',                'tp.overtime_status',                'tp.receive_department',                'tp.finish_department',                'tp.rebar_id',                'tp.beam_id',                'tp.quality_id',                'tp.lab_id',                'tp.machine_id',                'tp.prestress_id',                'tp.blend_id',                'tp.inform_paper',//是否是通知单                'tp.technologist_affirm',            ])            ->where('task_id',$task_id)            ->paginate(200, false, ['page'=>$page])            ->toArray();        //获取工序时长缓存        $cache = Cache::get("{$task_id}_time");        if (!$cache){//没有缓存            $process = new Process();            //查询表中数据            $where['time_limit'] = 1;            $info= $process->getProcess($where)->toArray();            foreach($info['data'] as $k=>$v){                $arr[$v['id']] =$v;            }            //存入缓存            Cache::set("{$task_id}_time",$arr);            //取出缓存            $cache = Cache::get("{$task_id}_time");        }        foreach ($data['data'] as &$item){            //有限制的,追加字段            if ($item['time_limit'] == 1){                //限制时长(秒)                $item['duration'] = floatval($cache[$item['process_id']]['duration'])*3600;            }            //处于返工状态,未完成的工序            if ($item['process_status']!=2){                //第二段所用时间                $time = time()-$item['confirm_time'];                //已用时间                $item['used_time'] = $item['used_time']+$time;            }            if($item['return_status'] == 1){                $item['return_id'] = Db::name('return_task')                    ->where(['task_id'=>$task_id,'process_id'=>$item['process_id']])                    ->order('create_time desc')                    ->value('id');            }        }        return $data;    }    //获取任务所有工序(后台使用)    function getConsoleProcess($task_id)    {        $list = $this->alias('tp')            ->join('process p','p.id=tp.process_id')            ->field([                'tp.id',                'tp.process_id',                'p.title',                'tp.process_status',                'tp.return_status',                'tp.overtime_status',                'tp.confirm_time',                'tp.used_time',            ])            ->where('task_id',$task_id)            ->paginate(200, false, ['query' => request()->get()]);        foreach ($list as &$item)        {            if (in_array($item['process_id'],[11,24,26,28,30])){//技术员的任务                $item['department'] = '工程部';                $field = 'technologist_id';            }else if (in_array($item['process_id'],[6,8])){//钢筋班的任务                $item['department'] = '钢筋班';                $field = 'rebar_id';            }else if (in_array($item['process_id'],[2,4,9,14,15,17,21])){//制梁班的任务                $item['department'] = '制梁班';                $field = 'beam_id';            }else if (in_array($item['process_id'],[5,7,10,32])){//安质部任务                $item['department'] = '安质部';                $field = 'quality_id';            }else if (in_array($item['process_id'],[12,16,19,22])){//试验室班任务                $item['department'] = '试验室';                $field = 'lab_id';            }else if ($item['process_id']==3){//物机部班任务                $item['department'] = '物机部';                $field = 'machine_id';            }else if (in_array($item['process_id'],[18,20,23,25,27,29,31])){//预应力班任务                $item['department'] = '预应力班';                $field = 'prestress_id';            }else if ($item['process_id']==13){//拌合站任务                $item['department'] = '拌合站';                $field = 'blend_id';            }else{                $item['department'] = '';                $field = '';            }            $user = new User();            $flow = new TaskFlow();            //负责人id            $item['duty_id'] = $flow->where('task_id',$task_id)->value($field);            $item['duty_name'] = $user->where('id',$item['duty_id'])->value('name');        }        return $list;    }}